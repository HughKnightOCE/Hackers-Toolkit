"""Vulnerability scanner"""
from datetime import datetime
from utils.logger import Logger
from utils.validators import Validators

class VulnerabilityScanner:
    """Scan for known vulnerabilities"""
    
    def __init__(self):
        self.cve_database = self._load_cve_patterns()
    
    def _load_cve_patterns(self):
        """Load common vulnerability patterns"""
        return {
            "CVE-2021-44228": {
                "name": "Log4Shell",
                "severity": "CRITICAL",
                "affected_versions": ["log4j < 2.17.0"],
                "description": "Remote Code Execution in Apache Log4j"
            },
            "CVE-2021-21985": {
                "name": "VMware vCenter",
                "severity": "CRITICAL",
                "description": "Remote Code Execution in vCenter Server"
            },
            "CVE-2021-34523": {
                "name": "ProxyShell",
                "severity": "CRITICAL",
                "affected_versions": ["Exchange < 15.1"],
                "description": "Exchange Server Remote Code Execution"
            }
        }
    
    def scan_port_vulnerability(self, ip, port):
        """Check port for known vulnerabilities"""
        if not Validators.is_valid_ip(ip):
            return {"error": "Invalid IP"}
        
        if not Validators.is_valid_port(port):
            return {"error": "Invalid port"}
        
        vulnerabilities = []
        
        # Common port vulnerability patterns
        port_vulns = {
            22: ["SSH Version Enumeration", "Brute Force Risk"],
            23: ["Telnet - Unencrypted Communication"],
            80: ["HTTP - Unencrypted", "Web Server Vulnerabilities"],
            445: ["SMB - Lateral Movement Risk"],
            3389: ["RDP - Brute Force Risk"],
            3306: ["MySQL - Database Enumeration"],
            5432: ["PostgreSQL - Database Enumeration"]
        }
        
        if port in port_vulns:
            vulnerabilities = port_vulns[port]
        
        return {
            "ip": ip,
            "port": port,
            "potential_vulnerabilities": vulnerabilities,
            "scan_date": datetime.now().isoformat()
        }
    
    def scan_service_vulnerability(self, service_name, version=None):
        """Check service for known vulnerabilities"""
        if not service_name:
            return {"error": "Service name required"}
        
        # Simplified service vulnerability check
        vulnerabilities = []
        
        service_patterns = {
            "apache": ["CVE-2021-41773", "CVE-2021-42013"],
            "nginx": ["CVE-2022-24765"],
            "openssh": ["CVE-2021-41617"],
            "mysql": ["CVE-2021-2109"],
            "postgresql": ["CVE-2022-1552"]
        }
        
        service_lower = service_name.lower()
        if service_lower in service_patterns:
            vulnerabilities = service_patterns[service_lower]
        
        return {
            "service": service_name,
            "version": version,
            "known_cves": vulnerabilities,
            "recommendation": "Update to latest patched version"
        }
    
    def generate_vulnerability_report(self, scan_results):
        """Generate vulnerability report from scan results"""
        report = {
            "scan_date": datetime.now().isoformat(),
            "vulnerabilities_found": 0,
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0,
            "details": []
        }
        
        Logger.info("Vulnerability report generated")
        return report
